---
title: "TP final: Salarios en STEM"
author: "Jerónimo Barragán, Guido Rossi, Florencia Fontana Walser"
output: html_document
date: "2022-11-16"
editor_options: 
  markdown: 
    wrap: 72
---

# Análisis exploratorio

## Dataset original

```{r}
require(tidyverse)
require(dplyr)
require(usdata)
require(usmap)
require(ggridges)
require("Hmisc")
require(corrplot)
require(rje) 
```

Leemos el dataset, el cual fue sacado de Kaggle. Los datos provienen de
\_Levels.fyi\_, un sitio que recopila salarios de muchos rubros y
empresas en todo el mundo. Este dataset contiene salarios de
trabajadores del área de tecnología, ingeniería, ciencia y matemática de
las más grandes companías.

```{r}
datos <- read_csv("Levels-Fyi-Salary-Data.csv")
head(datos)
```

Vemos que el dataset contiene alrededor de 62 mil filas y 29 columnas.
Las `timestamps` (fecha y hora en que se registro la fila) van del 2017
al 2021, las variables catégoricas están "dummificadas", es decir, en el
dataset aparecian con valores 0 y 1 (lo cual es incómodo), y las
ubicaciones de los trabajos son de varios países (sólo nos van a
interesar las de los Estados Unidos). Además, variables como `gender`,
`Race` y `Education` contienen NAs. Limpiaremos todo esto para trabajar
con un dataset más prolijo.

```{r}
# retenemos las columnas relevantes
datos2 <- datos %>% select(company, title,bonus,
                                   location,yearsofexperience,
                                   yearsatcompany,
                                   basesalary,gender,
                                   Race,Education) %>%
  filter(!is.na(gender),!is.na(Race),!is.na(Education)) 

# En este caso queremos quedarnos solamente con los salarios de trabajos en Estados Unidos. En la columna `location` los salarios de los demás países incluyen el nombre del país (mientras que los de EE.UU. no).
# Para quedarnos con los de EE.UU. retenemos las locaciones que tengan el código del estado al final con regular expressions y separamos la ciudad del estado en columnas distintas.

datos_usa <- subset(datos2, grepl("{2}[A-Z]$", location))
# Creo columna con estados y le cambio la sigla por el nombre
datos_usa$state <- sapply(strsplit(datos_usa$location, ","), "[", 2) 
datos_usa$state <- gsub( " ", "", datos_usa$state)
datos_usa$state <-  abbr2state(datos_usa$state)

# Modificamos columna con ciudades
colnames(datos_usa)[4] <- "city"
datos_usa$city <- sapply(strsplit(datos_usa$city, ","), "[", 1)

# Hacemos de la educación una variable ordinal 

datos_usa$Education <- factor(datos_usa$Education, levels = c("Highschool", "Some College", "Bachelor's Degree","Master's Degree","PhD"))
```

## Dataset limpio

Ahora tenemos una columna para la ciudad y otra para el estado. Tampoco
quedaron NA's en el dataset. Las columnas con las que trabajaremos son
las siguientes:

-   `company`: la companía donde trabaja el empleado.
-   `title`: título.
-   `bonus`: bonificación. Está basada mayormente en la performance
    anual de la companía.
-   `city`: ciudad.
-   `yearsofexperience`: años de experiencia.
-   `yearsatcompany`: años que lleva trabajando en la companía.
-   `basesalary`: salario base.
-   `gender`: género.
-   `Race`: etnia.
-   `Education`: nivel educativo.
-   `state`: Estado donde vive.

```{r}
head(datos_usa)
```

# Objetivos y preguntas

-   ¿Afecta el nivel de educación en un salario? ¿Es realmente necesario
    un PhD para tener un salario alto?
-   ¿Qué variables inciden en la remuneración de una persona del rubro?
-   Predecir el salario de un trabajador del sector.

# Análisis exploratorio de nuestros datos

## Ubicación

Veamos algunas relaciones entre las variables de nuestro dataset.
Comencemos con la ubicación de cada puesto.

```{r}
datos_states <- arrange(as.data.frame(table(datos_usa$state)), desc(Freq))
colnames(datos_states)[1] <- "states"
datos_states
```

Observamos que la mayoría de puestos provienen de California, Washington
y New York.

Veamos el salario promedio por Estado.

```{r}
prom_states <- datos_usa %>% select(state, basesalary) %>%
  group_by(state) %>%
  mutate(meansalary = mean(basesalary)) %>%
  arrange(desc(meansalary)) %>% 
  select(state,meansalary) %>%
  distinct()

top_10 <- prom_states[1:10,]
  
ggplot(data=top_10, mapping=aes(x=reorder(state, meansalary), y=meansalary)) + 
  stat_summary(fun.data=mean_sdl, geom="bar")+
  labs(x = "Estado", y = "Salario base (USD)")+
  coord_flip()
```

Se puede ver que el salario promedio más alto proviene de California. Creemos que se debe a que allí se encuentra Silicon Valley, la meca tecnológica donde las empresas más grandes ubican sus sedes, como Google, Amazon, Apple, Oracle, etc.

## Etnia

```{r}
etnias <- as.data.frame(table(datos_usa$Race))

raceplot_data <- datos_usa %>% 
  count(Race) %>% 
  mutate(percent = n/sum(n))

ggplot(raceplot_data, aes(x="", y=percent*100, fill = Race)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start = 0) +
  labs(fill = "Etnia")+
  theme_void()


```

A simple vista, pareciera ser que los asiáticos predominan en el rubro,
pues el piechart muestra que la cantidad de asiáticos supera al de
cualquier otra etnia.

## Género

Consideremos los porcentajes de cada género en nuestro dataset.

```{r}

data <- as.data.frame(table(datos_usa$gender))

ggplot(data, aes(x="", y=Freq, fill=Var1)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) +
  theme_void() +
  labs(fill = "Género")
```

## Educación

```{r warning=FALSE}
ggplot(data = datos_usa,
  mapping = aes(
  x = basesalary, fill = Education)) + 
  labs(x = "Salario base (USD)", y = "Cantidad", fill = "Educación") +
  geom_histogram(binwidth=10000, alpha = 0.3, position = "identity") +
  xlim(0,3.5e+05) +
  geom_vline(aes(xintercept = mean(datos_usa$basesalary[datos_usa$Education=="Highschool"])), col = "#F8766D", alpha = 1) +
  geom_vline(aes(xintercept = mean(datos_usa$basesalary[datos_usa$Education=="Some College"])), col = "#A3A500", alpha = 1) +
  geom_vline(aes(xintercept = mean(datos_usa$basesalary[datos_usa$Education=="Bachelor's Degree"])), col = "#00BF7D", alpha = 1) +
  geom_vline(aes(xintercept = mean(datos_usa$basesalary[datos_usa$Education=="Master's Degree"])), col = "#00B0F6", alpha = 1) +
  geom_vline(aes(xintercept = mean(datos_usa$basesalary[datos_usa$Education=="PhD"])), col = "#E76BF3", alpha = 1) +
  facet_grid(Education ~ ., scales = "free")

#Imprimimos la varianza de cada nivel educativo
for(nivel in levels(datos_usa$Education)) {
  print(nivel)
  print(var(datos_usa$basesalary[datos_usa$Education==nivel]))
}
```

Podemos ver que las distribuciones del salario base por nivel de
educación se solapan considerablemente entre sí. Es decir, el nivel de
educación no parece ser, a priori, un indicador determinante en el
salario de una persona que trabaja en el sector. Sin embargo, podemos
observar que, conforme el nivel de educación es más elevado, la varianza
del salario base tiende a disminuir. Esto debe indicar que por lo menos
existe una relación entre la educación y el salario base, aunque no de
manera tan directa. Por ejemplo, puede estar ocurriendo que el salario
dependa del puesto de trabajo, y este a su vez dependa del nivel educativo.

## Puesto de trabajo en la companía

Estudiemos ahora si el salario base depende del puesto de trabajo en la
compañía. ¿Qué puestos de trabajo tenemos registrados?

```{r}
tabla <- arrange(as.data.frame(table(datos_usa$title)), desc(Freq))
colnames(tabla) <- c("Puesto", "Cantidad")
tabla
```

Podemos ver que hay 15 títulos registrados bien definidos en el dataset.
Consideremos el salario BASE de las personas que ocupan cada puesto.

```{r}
ggplot(data=datos_usa, mapping=aes(x=reorder(title,basesalary), y=basesalary)) + 
  stat_summary(fun.data=mean_sdl, geom="bar")+
  labs(x = "Puesto", y = "Salario base promedio (USD)")+
  coord_flip()

ggplot(data=datos_usa, mapping=aes(x=reorder(title,basesalary), y=basesalary)) + 
  geom_boxplot(outlier.shape = NA) +
  labs(x = "Puesto", y = "Salario base (USD)")+
  ylim(0,400000) +
  coord_flip()
```

Mediante el boxplot, podemos ver que los cuartiles tienden a correrse
hacia la derecha a medida que crece la jerarquía del puesto. Por otra
parte, el barplot nos dice que el salario promedio más alto es el de
Software Engineering Manager, que es casi de 200.000 dólares anuales.
Parecería ser, como es esperado, que los cargos superiores (Managers,
por ejemplo) conllevan un salario base superior. Por lo tanto, el puesto
de trabajo debe ser un factor incidente en el salario base.

¿Cómo se relaciona la educación con el puesto de trabajo?

```{r}
subsetTitle <- datos_usa[datos_usa$title %in% c( "Data Scientist","Software Engineering Manager", "Technical Program Manager", "Product Manager"), ]

titleplot_data <- subsetTitle %>% 
  count(Education, title) %>% 
  group_by(title) %>% 
  mutate(percent = n/sum(n))

ggplot(titleplot_data, aes(x="", y=percent*100, fill = Education)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start = 0) +
  theme_void() +
  labs(fill ="Educación") +
  facet_grid(title ~ .,  labeller = label_wrap_gen(width = 2, multi_line = TRUE))
```

Podemos ver que los puestos de trabajo por lo general mejor remunerados,
están ocupados en su mayoría por personas que han alcanzado un Bachelor
o un Master. En menor medida, siguen los que han alcanzado un PhD. Por
lo tanto, podemos ver que los puestos más altos requieren un nivel
educativo por lo menos universitario. En cuanto a los Data Scientists,
la proporción de ellos que ha alcanzado un PhD es mayor que para los
tres primeros puestos.

## Correlaciones entre variables

Veamos las correlaciones entre las variables continuas para tratar de
entender lo que nos muestra el dataset. Para eso utilizamos una matriz
de correlaciones.

```{r}
datos_usa_cont <- datos_usa %>% select(yearsofexperience,yearsatcompany,basesalary, bonus)
M <- cor(datos_usa_cont)
head(M)
corrplot(M, method="color")
```

En lo que concierne a nuestro análisis, vemos que el salario base se
encuentra positivamente correlacionado con los años de experiencia más
que cualquier otra variable, con el bonus en segundo lugar, y un poco
menos con los años en la compañía.

## Años de experiencia y en la compañía

```{r}
#datos_usa_ds <- datos_usa %>% filter(title == 'Data Scientist')

ajusM1 <- lm(basesalary ~ yearsofexperience, data = datos_usa)

ggplot(data = datos_usa, mapping = aes(x = yearsofexperience, y = basesalary)) + 
  geom_point(size=1) +
  geom_abline(color="blue", slope = coef(ajusM1)[2], intercept = coef(ajusM1)[1]) +
  labs(y = "Salario base (USD)", x = "Años de experiencia", color = "Género"  )

```

Vemos que, como era previsible, cuanto más años de experiencia, más alto
parece ser el salario base.

Ahora veamos como se relaciona el salario base con los años que lleva en
la empresa.

```{r}
ajusM2 <- lm(basesalary ~ yearsatcompany, data = datos_usa)

ggplot(data = datos_usa, mapping = aes(x = yearsatcompany, y = basesalary)) + 
  geom_point() +
  geom_abline(color="blue", slope = coef(ajusM2)[2], intercept = coef(ajusM2)[1]) +
  labs(y = "Salario base (USD)", x = "Años en la compañía", color = "Género") +
  scale_x_continuous(limits = c(0,40), breaks=seq(0,40,by=10))
```

Vemos una relación similar entre el salario base y los años en la
companía. Sin embargo, se pueden observar personas con 0 años en la
empresa que tienen un salario mayor a personas que ya llevan 20, por
ejemplo.

# Modelado

Luego de explorar los datos y las relaciones entre las variables,
observamos que: - La educación debe ser un factor incidente en el
salario aunque no decisivo, dado que vimos que no podemos decidir el
salario de una persona conociendo únicamente su nivel educativo, aunque
un nivel educativo alto permite acceder a puestos mejor remunerados. -
El comportamiento del salario base difiere marcadamente con cada puesto
de trabajo desempeñado, por ende esta debe ser una variable incidente en
el mismo. - Las correlaciones entre el salario base y los años de
experiencia en la compañía resultan positivas, y al graficar, captamos
cierta relación lineal entre ambas. - Si bien el bonus está
correlacionado con el salario base, es una variable muy dependiente del
contexto particular de la compañía (otra variable muy diversa) al
momento en que se registró cada observación.

Por lo tanto, para construir un modelo del salario base e intentar
predecirlo, elegimos construir modelos lineales utilizando las variables
`yearsofexperience`, `yearsatcompany`, `title` y `Education`.

```{r}
#Creamos funciones para calcular el PMAE por validación cruzada de los modelos
#que construiremos.
PMAE <- function(errores, datos, target) {
  return(mean(errores)/mean(datos[[target]]))
}

crossval <- function(datos, modelo, porcentajeEval, fun_error=PMAE, n_muestras=10){
  target <- strsplit(modelo, "[~]")[[1]][1]
  errores <- c()
  for(i in 1:n_muestras) {
    indicesEval <- sample(1:nrow(datos), size = (porcentajeEval/100)*nrow(datos))
    datosModelo <- datos[-indicesEval,]
    modeloLin <- lm(formula(modelo), data = datosModelo)
    abserrs <- c()
    for(o in indicesEval) {
      predicho <- predict(modeloLin, newdata = datos[o,])
      abserrs <- c(abserrs, abs(datos[[target]][o]-predicho))
    }
    errores <- c(errores, fun_error(abserrs, datos, target))
  }
  return(list(errores, mean(errores), var(errores), modelo, lm(formula(modelo), data = datos)))
}

#Seteamos la semilla para que los resultados sean los mismos cada vez que
#se corra el código.
set.seed(123)
```

```{r}
#Creamos un vector con las variables predictoras
predictoras <- c("yearsofexperience", "yearsatcompany", "title", "Education")

partes <- powerSet(predictoras)

casos <- length(partes)-1

datos_modelo <- data.frame( 
            'Modelo' = rep(NA, casos),
            'PMAE' = rep(NA, casos)
)

l <- 1
for(i in 1:4) {
  modelos <- partes[lapply(partes, length) == i]
  for(m in modelos) {
    formula <- paste("basesalary~",paste(m, collapse = '+'), sep = "")
    ajuste <- crossval(datos_usa, formula, 10, PMAE, 10)
    PMAEcv <- ajuste[2]
    datos_modelo[l,] <- c(formula, PMAEcv)
    l <- l+1
  }
}

# Ordenamos y mostramos los PMAEs obtenidos de cada modelo
datos_modelo <- datos_modelo %>% arrange(desc(PMAE))
datos_modelo

# Devolvemos la fila de menor PMAE
print(datos_modelo[which.min(datos_modelo[,2]),])
```

```{r}
datos_modelo %>%
  ggplot(aes(x=PMAE, y=reorder(Modelo, PMAE))) + 
  geom_bar(stat = "identity", width=0.5) + 
  theme(plot.title = element_text(hjust=0.5)) +
  ylab("Modelo") + 
  ggtitle("PMAEs por CV de los 15 modelos") 
```

Una observación importante es que el modelo que considera todas las
variables arroja un PMAE muy similar al que considera todas menos
`yearsatcompany`, es decir que tienen capacidades predictivas casi
idénticas.

Por otro lado, podemos ver que los modelos que difieren tan solo en si
consideran la variable `title` o `Education` o ambas, también tienen
capacidades predictivas muy similares. De hecho, performan mejor a la
hora de predecir el salario, aquellos que consideran solo el puesto de
trabajo (`title`) en lugar del nivel educativo (`Education`).

Finalmente mostramos el modelo que mejor predice el salario con sus
respectivos coeficientes.

```{r}
# Mostramos el modelo con los coeficientes

ajuste_mejor <- crossval(datos_usa, "basesalary~yearsofexperience+title+Education", 10, PMAE, 10)
#coeficientes_mejor <- coef(ajuste_mejor)
#coeficientes_mejor
ajuste_mejor[5]
```

Y grafiquemos algunos salarios base predichos por el mejor modelo contra los salarios 
base reales, para entender de una manera más gráfica el PMAE arrojado.
D
```{r}
modelo_mejor <- lm("basesalary~yearsofexperience+title+Education", data = datos_usa)
obsRows <- sample(1:nrow(datos_usa), size = 500)

pred <- c()
for(i in obsRows) {
  pred <- append(pred, predict(modelo_mejor, newdata = datos_usa[i,]))
}

obs <- c()
for(i in obsRows) {
  obs <- append(obs, datos_usa$basesalary[i])
}

ggplot(data = data.frame(x=obs, y=pred), mapping = aes(x, y)) +
  geom_point(size=1) +
  #La recta roja indica el conjunto de puntos donde la predicción y la observación coinciden.
  geom_abline(color = "red", slope = 1, intercept = 0) +
  xlab("Salario base observado (USD)") +
  ylab("Salario base predicho (USD)") +
  xlim(0, 3e+05)
```



# Conclusiones

-   El mejor modelo es el que predice el salario base según los años de
    experiencia, el título y la educación, con un error del 17%
    aproximadamente.
-   El nivel educativo afecta al salario positivamente, aunque no es
    determinante, ya que vimos personas con título secundario tener el
    mismo salario que personas con doctorado. Observando los
    coeficientes del modelo, notamos que el coeficiente del PhD supera
    ampliamente al resto de los niveles de educación, con lo cual,
    afirmamos que un nivel educativo alto aumenta las posibilidades de
    tener un salario alto.
-   A la hora de estimar el salario vimos que, los años de experiencia
    es la variable numérica más importante (los PMAEs de modelos con
    esta variable son menores), y más atrás quedan el puesto, la
    educación y por último los años en la compañía.
